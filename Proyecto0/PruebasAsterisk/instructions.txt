*) actualizar todos los paquetes a la última versión

apt-get update -y
apt-get upgrade -y

*) instalar algunas dependencias necesarias para FreePBX

apt-get install unzip git gnupg2 curl libnewt-dev libssl-dev libncurses5-dev subversion libsqlite3-dev build-essential libjansson-dev libxml2-dev uuid-dev subversion -y

*) FreePBX requiere un Asterisk para estar instalado en su servidor
*) descargar la última versión de Asterisk 

wget http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-18-current.tar.gz

*) extraer el archivo descargado

tar -xvzf asterisk-18-current.tar.gz

*) ejecute el siguiente script para instalar todas las dependencias necesarias:

cd asterisk-18.*
contrib/scripts/get_mp3_source.sh
contrib/scripts/install_prereq install

*) ir al menu de configuracion:

./configure

*) Se debe ver asi:

configure: Menuselect build configuration successfully completed

               .$$$$$$$$$$$$$$$=..
            .$7$7..          .7$$7:.
          .$$:.                 ,$7.7
        .$7.     7$$$$           .$$77
     ..$$.       $$$$$            .$$$7
    ..7$   .?.   $$$$$   .?.       7$$$.
   $.$.   .$$$7. $$$$7 .7$$$.      .$$$.
 .777.   .$$$$$$77$$$77$$$$$7.      $$$,
 $$$~      .7$$$$$$$$$$$$$7.       .$$$.
.$$7          .7$$$$$$$7:          ?$$$.
$$$          ?7$$$$$$$$$$I        .$$$7
$$$       .7$$$$$$$$$$$$$$$$      :$$$.
$$$       $$$$$$7$$$$$$$$$$$$    .$$$.
$$$        $$$   7$$$7  .$$$    .$$$.
$$$$             $$$$7         .$$$.
7$$$7            7$$$$        7$$$
 $$$$$                        $$$
  $$$$7.                       $$  (TM)
   $$$$$$$.           .7$$$$$$  $$
     $$$$$$$$$$$$7$$$$$$$$$.$$$$$$
       $$$$$$$$$$$$$$$$.

configure: Package configured for:
configure: OS type  : linux-gnu
configure: Host CPU : x86_64
configure: build-cpu:vendor:os: x86_64 : pc : linux-gnu :
configure: host-cpu:vendor:os: x86_64 : pc : linux-gnu :

*) para seleccionar modulos y complementos de Asterisk, ejecutar el siguiente comando:

make menuselect

*) Se seleccionan atravez de una interfaz, navegar con el teclado y el raton:
*) Habilitar:

Add-ons:
- chan_mobile
- chan_ooh323
- format_mp3
- res_config_msql

Modulos de sonidos centrales

Core Sounds Packages:
- CORE-SOUNDS-EN-WAV
- CORE-SOUNDS-EN-ULAM
- CORE-SOUNDS-EN-GSM
- CORE-SOUNDS-EN-G729
- CORE-SOUNDS-EN-G722
- CORE-SOUNDS-EN-SLN16
- CORE-SOUNDS-EN-SIREN7
- CORE-SOUNDS-EN-SIREN14

Modulos de musica de espera

Music On Hold File Package:
- MOH-OPSOUND-WAV
- MOH-OPSOUND-ULAM
- MOH-OPSOUND-ALAM
- MOH-OPSOUND-GSM

Modulos de sonidos extra:

Extra Sounds Package:
- EXTRA-SOUNDS-EN-WAV
- EXTRA-SOUNDS-EN-ULAM
- EXTRA-SOUNDS-EN-ALAM
- EXTRA-SOUNDS-EN-GSM
- EXTRA-SOUNDS-EN-G729
- EXTRA-SOUNDS-EN-G722
- EXTRA-SOUNDS-EN-SLN16
- EXTRA-SOUNDS-EN-SIREN7

*) Despues de seleccionar todos los componentes necesarios, hacer clic en el boton Guardar y salir para cerrar la consola.
*) Ejecutar el siguiente comando para compilar el asterisco:

make -j2

*)  instale Asterisk

make install

*) ejecutar los siguientes comandos para instalar ejemplos y configurar:

make samples
make config
ldconfig

*) crear un usuario y un grupo dedicados para ejecutar Asterisk

groupadd asterisk
useradd -r -d /var/lib/asterisk -g asterisk asterisk

*) agregar a los usuarios de audio y llamada al grupo Asterisk:

usermod -aG audio,dialout asterisk

*) establecer el permiso y la propiedad adecuados en el asterisk:

chown -R asterisk.asterisk /etc/asterisk
chown -R asterisk.asterisk /var/{lib,log,spool}/asterisk
chown -R asterisk.asterisk /usr/lib/asterisk

*) editar el archivo de configuracion predeterminado de Asterisk:

nano /etc/default/asterisk

*) cambiar las siguientes lineas:

AST_USER="asterisk"
AST_GROUP="asterisk"

*) guardar y cerrar el archivo y, luego editar el archivo de configuracion de Asterisk:

nano /etc/asterisk/asterisk.conf

*) cambiar las siguientes lineas:

runuser = asterisk ; The user to run as.
rungroup = asterisk ; The group to run as.

*) guardar y cerrar el archivo y luego reinicie el servicio Asterisk:

systemctl restart asterisk

*) verificar el estado del asterisk mediante el siguiente comando:

systemctl status asterisk

*) aparecera el error radcli:

● asterisk.service - LSB: Asterisk PBX
     Loaded: loaded (/etc/init.d/asterisk; generated)
     Active: active (running) since Fri 2022-03-11 03:07:37 UTC; 10s ago
       Docs: man:systemd-sysv-generator(8)
    Process: 44796 ExecStart=/etc/init.d/asterisk start (code=exited, status=0/SUCCESS)
      Tasks: 81 (limit: 4686)
     Memory: 46.1M
     CGroup: /system.slice/asterisk.service
             └─44826 /usr/sbin/asterisk -U asterisk -G asterisk

Mar 11 03:07:36 freepbx systemd[1]: Starting LSB: Asterisk PBX...
Mar 11 03:07:37 freepbx asterisk[44796]:  * Starting Asterisk PBX: asterisk
Mar 11 03:07:37 freepbx asterisk[44796]:    ...done.
Mar 11 03:07:37 freepbx systemd[1]: Started LSB: Asterisk PBX.
Mar 11 03:07:37 freepbx asterisk[44826]: radcli: rc_read_config: rc_read_config: can't open /etc/radiusclient-ng/radiusclient.conf: No such f>
Mar 11 03:07:37 freepbx asterisk[44826]: radcli: rc_read_config: rc_read_config: can't open /etc/radiusclient-ng/radiusclient.conf: No such f>
lines 1-16/16 (END)

Para corregir el error , ejecutar:

sed -i 's";\[radius\]"\[radius\]"g' /etc/asterisk/cdr.conf
sed -i 's";radiuscfg => /usr/local/etc/radiusclient-ng/radiusclient.conf"radiuscfg => /etc/radcli/radiusclient.conf"g' /etc/asterisk/cdr.conf
sed -i 's";radiuscfg => /usr/local/etc/radiusclient-ng/radiusclient.conf"radiuscfg => /etc/radcli/radiusclient.conf"g' /etc/asterisk/cel.conf

*) reinicia el servicio Asterisk

systemctl restart asterisk

*) conectarse a la consola de Asterisk

asterisk -rvv

La siguiente consola es la buena

Asterisk 18.10.1, Copyright (C) 1999 - 2021, Sangoma Technologies Corporation and others.
Created by Mark Spencer <markster@digium.com>
Asterisk comes with ABSOLUTELY NO WARRANTY; type 'core show warranty' for details.
This is free software, with components licensed under the GNU General Public
License version 2 and other licenses; you are welcome to redistribute it under
certain conditions. Type 'core show license' for details.
=========================================================================
Running as user 'asterisk'
Running under group 'asterisk'
Connected to Asterisk 18.10.1 currently running on freepbx (pid = 44958)
freepbx*CLI>

*) ejecutar el siguiente comando para salir de la consola.

freepbx*CLI> exit
